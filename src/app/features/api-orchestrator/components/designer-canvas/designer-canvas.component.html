<!-- src/app/features/api-orchestrator/components/designer-canvas/designer-canvas.component.html -->

<main class="designer-canvas">
  <!-- Overlay transparent pour capturer les drag/drop -->
  <div 
    class="drop-overlay"
    (dragover)="onHostDragOver($event)"
    (drop)="onHostDrop($event)"
  ></div>

  <svg
    #canvas
    class="canvas-svg"
  >
    <!-- Grille de fond -->
    <defs>
      <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
        <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#f0f0f0" stroke-width="0.5"/>
      </pattern>
    </defs>
    <rect width="100%" height="100%" fill="url(#grid)" />

    <!-- Connexions -->
    <line
      *ngFor="let conn of connections()"
      [attr.x1]="getPortPosition(conn.sourceBlockId, conn.sourcePortId).x"
      [attr.y1]="getPortPosition(conn.sourceBlockId, conn.sourcePortId).y"
      [attr.x2]="getPortPosition(conn.targetBlockId, conn.targetPortId).x"
      [attr.y2]="getPortPosition(conn.targetBlockId, conn.targetPortId).y"
      stroke="#3B82F6"
      stroke-width="2"
      fill="none"
      class="connection-line"
      (click)="onConnectionClick($event, conn.id)"
    />
  </svg>

  <!-- Blocs -->
  <div class="blocks-container">
    <div
      *ngFor="let block of blocks()"
      class="block"
      [class.selected]="block.id === selectedBlockId"
      [style.left.px]="block.position.x"
      [style.top.px]="block.position.y"
      draggable="true"
      (dragstart)="onBlockDragStart($event, block.id)"
      (dragend)="onBlockDragEnd($event)"
      (mousedown)="onBlockSelected($event, block.id)"
    >
      <!-- Header du bloc -->
      <div class="block-header" [style.background-color]="getBlockColor(block.id)">
        <span class="block-icon">{{ getBlockIcon(block.type) }}</span>
        <span class="block-title">{{ block.name }}</span>
        <button class="block-delete" (click)="onBlockDelete($event, block.id)">×</button>
      </div>

      <!-- Ports d'entrée (gauche) -->
      <div class="block-inputs">
        <div
          *ngFor="let port of getBlockInputPorts(block.id)"
          class="port port-input"
          [title]="port.name"
          (dragover)="onPortDragOver($event)"
          (drop)="onPortDrop($event, block.id, port.id, 'input')"
        >
          <div class="port-dot"></div>
          <span class="port-label">{{ port.name }}</span>
        </div>
      </div>

      <!-- Ports de sortie (droite) -->
      <div class="block-outputs">
        <div
          *ngFor="let port of getBlockOutputPorts(block.id)"
          class="port port-output"
          [title]="port.name"
          draggable="true"
          (dragstart)="onPortDragStart($event, block.id, port.id)"
        >
          <span class="port-label">{{ port.name }}</span>
          <div class="port-dot"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ligne de connexion temporaire pendant le drag -->
  <svg
    *ngIf="dragLine"
    class="canvas-svg drag-line-overlay"
  >
    <line
      [attr.x1]="dragLine.from.x"
      [attr.y1]="dragLine.from.y"
      [attr.x2]="dragLine.to.x"
      [attr.y2]="dragLine.to.y"
      stroke="#3B82F6"
      stroke-width="2"
      stroke-dasharray="5,5"
    />
  </svg>
</main>