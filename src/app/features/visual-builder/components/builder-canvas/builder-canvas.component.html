<!-- src/app/features/visual-builder/components/builder-canvas/builder-canvas.component.html -->

<div 
  class="builder-canvas"
  [class.dragging]="canvasDragging()"
  [attr.data-zoom]="zoomLevel()"
  [attr.data-view-mode]="viewMode()">
  
  <!-- BARRE D'INFORMATIONS DE SÃ‰LECTION -->
  <div class="selection-info-bar" *ngIf="selectionCount() > 0">
    <div class="selection-badge">
      <span class="badge-icon">âœ“</span>
      <span class="badge-text">{{ selectionInfo() }}</span>
    </div>
    
    <div class="selection-actions">
      <button 
        class="action-btn action-deselect"
        (click)="clearSelection()"
        title="DÃ©sÃ©lectionner (Escape)">
        <span class="btn-icon">âŒ</span>
        <span class="btn-text">DÃ©sÃ©lectionner</span>
      </button>
      
      <button 
        class="action-btn action-duplicate"
        (click)="duplicateSelected()"
        title="Dupliquer (Ctrl+D)">
        <span class="btn-icon">ğŸ“‹</span>
        <span class="btn-text">Dupliquer ({{ selectionCount() }})</span>
      </button>
      
      <button 
        class="action-btn action-delete"
        (click)="deleteSelected()"
        title="Supprimer (Delete)">
        <span class="btn-icon">ğŸ—‘ï¸</span>
        <span class="btn-text">Supprimer ({{ selectionCount() }})</span>
      </button>
    </div>
  </div>
  
  <!-- CANVAS PRINCIPAL -->
  <div 
    class="canvas-content"
    (click)="onCanvasClick($event)"
    (dragover)="onCanvasDragOver($event)"
    (dragleave)="onCanvasDragLeave($event)"
    (drop)="onCanvasDrop($event)">
    
    <!-- GUIDE D'UTILISATION -->
    <div class="canvas-guide" *ngIf="components().length === 0">
      <div class="guide-content">
        <span class="guide-icon">ğŸ¨</span>
        <h3 class="guide-title">Canvas vide</h3>
        <p class="guide-description">
          Glissez un composant depuis la palette pour commencer
        </p>
        
        <div class="guide-shortcuts">
          <h4 class="shortcuts-title">ğŸ’¡ Raccourcis de sÃ©lection</h4>
          <div class="shortcuts-list">
            <div class="shortcut-item">
              <kbd>Click</kbd>
              <span>SÃ©lectionner un composant</span>
            </div>
            <div class="shortcut-item">
              <kbd>Ctrl + Click</kbd>
              <span>Ajouter/Retirer de la sÃ©lection</span>
            </div>
            <div class="shortcut-item">
              <kbd>Shift + Click</kbd>
              <span>SÃ©lectionner une plage</span>
            </div>
            <div class="shortcut-item">
              <kbd>Ctrl + A</kbd>
              <span>Tout sÃ©lectionner</span>
            </div>
            <div class="shortcut-item">
              <kbd>Escape</kbd>
              <span>DÃ©sÃ©lectionner</span>
            </div>
            <div class="shortcut-item">
              <kbd>Delete</kbd>
              <span>Supprimer</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- LISTE DES COMPOSANTS -->
    <div class="components-list" *ngIf="components().length > 0">
      <ng-container *ngFor="let component of components(); let i = index">
        <ng-container *ngTemplateOutlet="componentItem; context: { 
          $implicit: component, 
          index: i 
        }">
        </ng-container>
      </ng-container>
    </div>
    
    <!-- INDICATEUR DE DROP ZONE GLOBALE -->
    <div class="drop-indicator" *ngIf="canvasDragging()">
      <div class="indicator-content">
        <span class="indicator-icon">ğŸ“</span>
        <span class="indicator-text">DÃ©posez ici pour ajouter au canvas</span>
      </div>
    </div>
    
  </div>
  
  <!-- LÃ‰GENDE DE SÃ‰LECTION (bas du canvas) -->
  <div class="selection-legend" *ngIf="components().length > 0">
    <div class="legend-items">
      <div class="legend-item">
        <div class="legend-color single"></div>
        <span class="legend-text">SÃ©lection simple</span>
      </div>
      <div class="legend-item">
        <div class="legend-color multi"></div>
        <span class="legend-text">SÃ©lection multiple</span>
      </div>
      <div class="legend-item">
        <div class="legend-color hover"></div>
        <span class="legend-text">Survol</span>
      </div>
    </div>
    
    <button 
      class="legend-select-all"
      (click)="selectAll()"
      title="SÃ©lectionner tout (Ctrl+A)">
      <span class="btn-icon">â˜‘ï¸</span>
      <span class="btn-text">Tout sÃ©lectionner</span>
    </button>
  </div>
  
</div>

<!-- ========================================= -->
<!-- TEMPLATE RÃ‰CURSIF POUR LES COMPOSANTS    -->
<!-- ========================================= -->

<ng-template #componentItem let-component let-index="index">
  <div 
    class="canvas-component"
    [class.selected]="isSelected(component)"
    [class.hovered]="isHovered(component)"
    [class.container]="canHaveChildren(component)"
    [class.hidden]="component.isHidden"
    [class.locked]="component.isLocked"
    [class.drop-zone-active]="isDropZoneActive(component.id)"
    [class.multi-selected]="hasMultipleSelection() && isSelected(component)"
    [attr.data-component-id]="component.id"
    [attr.data-component-type]="component.type"
    [attr.data-selection-index]="getSelectionBadge(component)"
    (click)="selectComponent(component, $event)"
    (mouseenter)="onComponentMouseEnter(component, $event)"
    (mouseleave)="onComponentMouseLeave(component, $event)"
    (dragover)="canHaveChildren(component) ? onContainerDragOver($event, component) : null"
    (drop)="canHaveChildren(component) ? onContainerDrop($event, component) : null">
    
    <!-- HEADER DU COMPOSANT -->
    <div class="component-header">
      <div class="header-left">
        <span class="component-icon">{{ getComponentIcon(component) }}</span>
        <span class="component-name">{{ component.displayName }}</span>
        <span class="component-type-badge">{{ component.type }}</span>
      </div>
      
      <div class="component-badges">
        <!-- Badge de sÃ©lection numÃ©rotÃ© -->
        <span 
          class="badge selection-badge"
          *ngIf="isSelected(component) && hasMultipleSelection()"
          [attr.data-number]="getSelectionBadge(component)">
          {{ getSelectionBadge(component) }}
        </span>
        
        <!-- Badge verrouillÃ© -->
        <span 
          class="badge locked-badge" 
          *ngIf="component.isLocked"
          title="VerrouillÃ©">
          ğŸ”’
        </span>
        
        <!-- Badge cachÃ© -->
        <span 
          class="badge hidden-badge" 
          *ngIf="component.isHidden"
          title="CachÃ©">
          ğŸ‘ï¸â€ğŸ—¨ï¸
        </span>
        
        <!-- Badge container -->
        <span 
          class="badge container-badge" 
          *ngIf="canHaveChildren(component)"
          title="Container">
          ğŸ“¦
        </span>
      </div>
    </div>
    
    <!-- CONTENU DU COMPOSANT -->
    <div class="component-content">
      
      <!-- Affichage du contenu selon le type -->
      <div class="content-preview">
        
        <!-- Texte (heading, paragraph) -->
        <ng-container *ngIf="component.type === 'heading' || component.type === 'paragraph'">
          <div class="text-content">
            {{ component.properties.content?.text || 'Texte vide' }}
          </div>
        </ng-container>
        
        <!-- Button -->
        <ng-container *ngIf="component.type === 'button'">
          <div class="button-preview">
            {{ component.properties.content?.text || 'Button' }}
          </div>
        </ng-container>
        
        <!-- Image -->
        <ng-container *ngIf="component.type === 'image'">
          <div class="image-preview">
            <img 
              [src]="component.properties.content?.src || 'https://via.placeholder.com/200x100'" 
              [alt]="component.properties.content?.alt || 'Image'"
              class="preview-img">
          </div>
        </ng-container>
        
        <!-- Input / Textarea -->
        <ng-container *ngIf="component.type === 'input' || component.type === 'textarea'">
          <div class="input-preview">
            <input 
              type="text" 
              [placeholder]="component.properties.content?.placeholder || 'Input'"
              disabled>
          </div>
        </ng-container>
        
        <!-- Container vide -->
        <ng-container *ngIf="canHaveChildren(component) && (!component.children || component.children.length === 0)">
          <div class="empty-container">
            <span class="empty-icon">ğŸ“¦</span>
            <span class="empty-text">Container vide</span>
            <span class="empty-hint">Glissez un composant ici</span>
          </div>
        </ng-container>
        
        <!-- Autres types -->
        <ng-container *ngIf="
          component.type !== 'heading' && 
          component.type !== 'paragraph' && 
          component.type !== 'button' &&
          component.type !== 'image' &&
          component.type !== 'input' &&
          component.type !== 'textarea' &&
          !canHaveChildren(component)">
          <div class="generic-preview">
            {{ component.type }}
          </div>
        </ng-container>
        
      </div>
      
      <!-- ENFANTS (si container) -->
      <div class="component-children" *ngIf="component.children && component.children.length > 0">
        <div class="children-label">
          <span class="label-icon">ğŸ“‚</span>
          <span class="label-text">{{ component.children.length }} enfant(s)</span>
        </div>
        
        <div class="children-list">
          <ng-container *ngFor="let child of component.children">
            <ng-container *ngTemplateOutlet="componentItem; context: { $implicit: child }">
            </ng-container>
          </ng-container>
        </div>
      </div>
      
    </div>
    
    <!-- INDICATEUR DE DROP ZONE (pour containers) -->
    <div 
      class="container-drop-zone" 
      *ngIf="canHaveChildren(component) && isDropZoneActive(component.id)">
      <span class="drop-zone-icon">â¬‡ï¸</span>
      <span class="drop-zone-text">DÃ©posez ici</span>
    </div>
    
    <!-- OVERLAY DE SÃ‰LECTION -->
    <div class="selection-overlay" *ngIf="isSelected(component)">
      <div class="overlay-border"></div>
    </div>
    
  </div>
</ng-template>