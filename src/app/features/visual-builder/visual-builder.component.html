<!-- src/app/features/visual-builder/visual-builder.component.html -->

<div 
  class="visual-builder"
  (keydown)="onKeyDown($event)"
  tabindex="0"
>
  
  <!-- ===== TOOLBAR ===== -->
  <header class="builder-header">
    <app-builder-toolbar></app-builder-toolbar>
  </header>
  
  <!-- ===== MAIN CONTENT ===== -->
  <div class="builder-main">
    
    <!-- ===== LEFT SIDEBAR: Component Palette ===== -->
    <aside class="builder-sidebar left">
      <app-component-palette
        (componentClick)="onComponentClick($event)"
      ></app-component-palette>
    </aside>
    
    <!-- ===== CENTER: Canvas ===== -->
    <main class="builder-canvas-container">
      <app-builder-canvas
        [components]="components()"
        [selectedComponentId]="selectedComponent()?.id || null"
        (componentSelected)="onComponentSelected($event)"
        (componentsSelected)="onComponentsSelected($event)"
        (componentsDeleted)="onComponentsDeleted($event)"
        (componentDropped)="onComponentDropped($event)"
      ></app-builder-canvas>
    </main>
    
    <!-- ===== RIGHT SIDEBAR: Tabs ===== -->
    <aside class="builder-sidebar right">
      
      <!-- Tabs Header -->
      <div class="sidebar-tabs">
        <button 
          class="tab-button"
          [class.active]="activeRightPanel() === 'layers'"
          (click)="switchRightPanel('layers')"
          title="Hiérarchie des composants"
        >
          📋 Layers
        </button>
        <button 
          class="tab-button"
          [class.active]="activeRightPanel() === 'properties'"
          (click)="switchRightPanel('properties')"
          title="Propriétés du composant"
        >
          ⚙️ Properties
        </button>
      </div>
      
      <!-- Tabs Content -->
      <div class="sidebar-content">
        
        <!-- Layers Panel -->
        @if (activeRightPanel() === 'layers') {
          <app-layers-panel></app-layers-panel>
        }
        
        <!-- Properties Panel -->
        @if (activeRightPanel() === 'properties') {
          
          <!-- 🆕 Cas sélection multiple -->
          @if (hasMultipleSelection()) {
            <div class="multi-selection-properties">
              <div class="properties-header">
                <h3>Sélection multiple</h3>
                <span class="selection-count">
                  {{ selectedComponents().length }} composants
                </span>
              </div>
              
              <div class="properties-content">
                <div class="info-box">
                  <p>💡 Les modifications seront appliquées à tous les composants sélectionnés</p>
                </div>
                
                <!-- Liste des composants sélectionnés -->
                <div class="selected-list">
                  <h4>Composants sélectionnés :</h4>
                  <ul>
                    @for (comp of selectedComponents(); track comp.id) {
                      <li>
                        <span class="comp-icon">
                          {{ comp.type === 'button' ? '🔘' : 
                             comp.type === 'heading' ? '🔤' :
                             comp.type === 'image' ? '🖼️' :
                             comp.type === 'input' ? '✏️' : '📦' }}
                        </span>
                        <span class="comp-name">{{ comp.displayName }}</span>
                        <span class="comp-type">{{ comp.type }}</span>
                      </li>
                    }
                  </ul>
                </div>
                
                <!-- Propriétés communes -->
                <div class="common-properties">
                  <h4>Propriétés communes</h4>
                  <p class="coming-soon">🚧 Édition groupée disponible prochainement</p>
                  
                  <!-- Exemple de propriétés communes (désactivées pour l'instant) -->
                  <div class="property-group disabled">
                    <label>Opacité</label>
                    <input type="range" min="0" max="100" value="100" disabled>
                  </div>
                  
                  <div class="property-group disabled">
                    <label>Marge</label>
                    <input type="text" placeholder="0px" disabled>
                  </div>
                  
                  <div class="property-group disabled">
                    <label>Padding</label>
                    <input type="text" placeholder="0px" disabled>
                  </div>
                </div>
                
                <!-- Actions groupées -->
                <div class="group-actions">
                  <h4>Actions groupées</h4>
                  <div class="actions-grid">
                    <button 
                      class="action-btn"
                      (click)="onComponentsDuplicated(selectedComponentIds())"
                      title="Dupliquer la sélection">
                      📋 Dupliquer
                    </button>
                    
                    <button 
                      class="action-btn"
                      (click)="onComponentsGrouped(selectedComponentIds())"
                      title="Grouper les composants">
                      📦 Grouper
                    </button>
                    
                    <button 
                      class="action-btn"
                      (click)="onComponentsLockToggled({ 
                        ids: selectedComponentIds(), 
                        locked: true 
                      })"
                      title="Verrouiller">
                      🔒 Verrouiller
                    </button>
                    
                    <button 
                      class="action-btn danger"
                      (click)="onComponentsDeleted(selectedComponentIds())"
                      title="Supprimer la sélection">
                      🗑️ Supprimer
                    </button>
                  </div>
                </div>
              </div>
            </div>
          }
          
          <!-- 🔄 Cas sélection simple (existant) -->
          @else {
            <app-properties-panel
              [selectedComponent]="selectedComponent()"
              [visible]="true"
              (propertyChanged)="onPropertyChanged($event)"
              (closed)="onPropertiesPanelClosed()"
            ></app-properties-panel>
          }
        }
        
      </div>
      
    </aside>
    
  </div>
  
  <!-- ===== STATUS BAR ===== -->
  <footer class="builder-footer">
    <div class="status-info">
      <span class="status-item">
        📦 {{ componentCount() }} composant{{ componentCount() > 1 ? 's' : '' }}
      </span>
      
      <!-- 🆕 Affichage de la sélection -->
      @if (hasMultipleSelection()) {
        <span class="status-item highlight">
          📊 {{ selectedComponents().length }} sélectionné(s)
        </span>
      } @else if (selectedComponent()) {
        <span class="status-item">
          📌 {{ selectedComponent()?.displayName }}
        </span>
      }
    </div>
    
    <!-- 🆕 Actions rapides pour sélection multiple -->
    @if (hasMultipleSelection()) {
      <div class="quick-actions">
        <button 
          class="quick-btn"
          (click)="onComponentsDuplicated(selectedComponentIds())"
          title="Dupliquer la sélection (Ctrl+D)">
          📋 Dupliquer
        </button>
        
        <button 
          class="quick-btn"
          (click)="onComponentsGrouped(selectedComponentIds())"
          title="Grouper (Ctrl+G)">
          📦 Grouper
        </button>
        
        <button 
          class="quick-btn"
          (click)="onComponentsLockToggled({ 
            ids: selectedComponentIds(), 
            locked: true 
          })"
          title="Verrouiller">
          🔒 Verrouiller
        </button>
      </div>
    }
  </footer>
  
</div>